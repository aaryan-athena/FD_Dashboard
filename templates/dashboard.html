<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fall Detection Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
                    <div class="container-fluid">
                        <a class="navbar-brand d-flex align-items-center" href="/">
                            <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="SteadyMatch Logo" class="navbar-logo me-2">
                            <span class="navbar-title">SteadyMatch Dashboard</span>
                        </a>
                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                        <div class="collapse navbar-collapse" id="navbarContent">
                            <ul class="navbar-nav ms-auto align-items-center">
                                <li class="nav-item">
                                    <a class="nav-link" href="/">
                                        <i class="fas fa-home me-1"></i>
                                        Home
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link active" href="/dashboard">
                                        <i class="fas fa-tachometer-alt me-1"></i>
                                        Dashboard
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="d-flex align-items-center gap-3 ms-3">
                            <button class="btn btn-sm theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle theme">
                                <i class="fas fa-moon" id="themeIcon"></i>
                            </button>
                            <span class="navbar-text d-none d-md-inline-block">
                                <i class="fas fa-clock me-1"></i>
                                Last Updated: <span id="lastUpdated"></span>
                            </span>
                        </div>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Notification Container -->
        <div id="notificationContainer" class="notification-container"></div>

        <!-- Stats Cards -->
        <div class="row mb-4 g-3">
            <div class="col-lg-3 col-md-6">
                <div class="card stat-card text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="card-text mb-2">Falls Today</p>
                                <h4 class="card-title text-white mb-0">{{ stats.today }}</h4>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card stat-card text-white" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="card-text mb-2" style="color: #8b4513;">This Week</p>
                                <h4 class="card-title mb-0" style="color: #8b4513;">{{ stats.this_week }}</h4>
                            </div>
                            <div class="stat-icon" style="color: #8b4513;">
                                <i class="fas fa-calendar-week"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card stat-card text-white" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="card-text mb-2">This Month</p>
                                <h4 class="card-title text-white mb-0">{{ stats.this_month }}</h4>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="card stat-card text-white" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="card-text mb-2">Total Falls</p>
                                <h4 class="card-title text-white mb-0">{{ stats.total }}</h4>
                            </div>
                            <div class="stat-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4 g-3">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="fas fa-chart-line me-2" style="color: #667eea;"></i>
                            Fall Detection Timeline (Last 30 Days)
                        </h5>
                    </div>
                    <div class="card-body" style="height: 400px;">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="fas fa-chart-pie me-2" style="color: #667eea;"></i>
                            Severity Distribution
                        </h5>
                    </div>
                    <div class="card-body" style="height: 180px;">
                        <canvas id="severityChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="fas fa-map-marker-alt me-2" style="color: #667eea;"></i>
                            Location Distribution
                        </h5>
                    </div>
                    <div class="card-body" style="height: 180px;">
                        <canvas id="locationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Falls Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2" style="color: #667eea;"></i>
                            Recent Falls
                        </h5>
                        <button class="btn btn-outline-primary btn-sm mt-2 mt-md-0" onclick="refreshData()">
                            <i class="fas fa-sync-alt me-1"></i>
                            Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="fallsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Location</th>
                                        <th>Device</th>
                                        <th>Method</th>
                                        <th>Confidence</th>
                                        <th>Duration</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for fall in falls %}
                                    <tr>
                                        <td data-label="Timestamp">
                                            <div class="timestamp">
                                                {{ fall.timestamp | format_datetime }}
                                            </div>
                                        </td>
                                        <td data-label="Location">
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-location-dot me-1"></i>
                                                {{ fall.location }}
                                            </span>
                                        </td>
                                        <td data-label="Device">{{ fall.person_id }}</td>
                                        <td data-label="Method">
                                            <span class="badge bg-info">
                                                <i class="fas fa-brain me-1"></i>
                                                {{ fall.detection_method or 'Motion' }}
                                            </span>
                                        </td>
                                        <td data-label="Confidence">
                                            <span class="badge severity-{{ fall.severity.lower() }}">
                                                {{ fall.confidence }}%
                                            </span>
                                        </td>
                                        <td data-label="Duration">{{ fall.duration }}s</td>
                                        <td data-label="Actions">
                                            <div class="action-buttons">
                                                <button class="btn btn-sm btn-outline-primary me-1" 
                                                        onclick="viewFallDetail('{{ fall.id }}')">
                                                    <i class="fas fa-eye"></i>
                                                    <span class="btn-text">View</span>
                                                </button>
                                                <button class="btn btn-sm btn-outline-success" 
                                                        onclick="playVideo('{{ fall.video_url }}', '{{ fall.id }}')">
                                                    <i class="fas fa-play"></i>
                                                    <span class="btn-text">Video</span>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="pagination-info">
                                Showing <span id="recordsInfo">10</span> of <span id="totalRecords">{{ stats.total }}</span> records
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm" id="pagination">
                                    <!-- Pagination will be populated by JavaScript -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Modal -->
    <div class="modal fade" id="videoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-video me-2"></i>
                        Fall Detection Video
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <video id="fallVideo" controls style="width: 100%; max-width: 600px;">
                        Your browser does not support the video tag.
                    </video>
                    <div class="mt-3">
                        <p class="text-muted" id="videoInfo"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <script type="application/json" id="dashboard-data">{{ {'stats': stats, 'falls': falls, 'mock_mode': mock_mode} | tojson | safe }}</script>
    <script>
        // Initialize dashboard with server data
        const dashboardDataElement = document.getElementById('dashboard-data');
        const dashboardData = JSON.parse(dashboardDataElement.textContent);
        
        // Notification System
        let lastFallCount = dashboardData.stats.total;
        let notificationSound = null;
        
        function createNotification(fall) {
            console.log('createNotification called with:', fall);
            const container = document.getElementById('notificationContainer');
            console.log('Notification container:', container);
            
            if (!container) {
                console.error('Notification container not found!');
                return;
            }
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">⚠️ Fall Detected!</div>
                    <div class="notification-message">
                        Location: ${fall.location}<br>
                        Confidence: ${fall.confidence}%
                    </div>
                    <div class="notification-time">${timeStr}</div>
                </div>
                <button class="notification-close" onclick="closeNotification(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            console.log('Notification added to container');
            
            // Play notification sound (optional)
            try {
                if (!notificationSound) {
                    notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGS57OihUQ0QT6Lh8LNnGwU7kdTz0HwwBSh+zPDalj4KFV+06eiqVhALSKDh8r1rIAUsgs7y2Ik1CBhlue3ooVEMEE+i4e+0aB0GO5HU89B8MAUofszw2pY+ChVftOnpq1YQC0mf4fK8ayAFLIHO8tiJNQgYZLnt6KFRCxBPouHvtGkcBjuR1PPQfDAFKH/M8NqWPwoVX7Tp6atWEAtJn+HyvGsgBSyCzvLYiTUIGWW57eihUQsQT6Lh77RpHAY7kdTz0HwwBSh/zPDalj4KFV+06emrVhALSZ/h8rxrIAUsgc7y2Ik1CBllue3ooVELEE+i4e+0aRwGO5HU89B8MAUof8zw2pY+ChVftOnpq1YQC0mf4fK8ayAFLIHO8tiJNQgZZbnt6KFRCxBPouHvtGkcBjuR1PPQfDAFKH/M8NqWPgoVX7Tp6atWEAtJn+HyvGsgBSyCzvLYiTUIGWW57eihUQsQT6Lh77RpHAY7kdTz0HwwBSh/zPDalj4KFV+06emrVhALSZ/h8rxrIAUsgc7y2Ik1CBllue3ooVELEE+i4e+0aRwGO5HU89B8MAUof8zw2pY+ChVftOnpq1YQC0mf4fK8ayAFLIHO8tiJNQgZZbnt6KFRCxBPouHvtGkcBjuR1PPQfDAFKH/M8NqWPgoVX7Tp6atWEAtJn+HyvGsgBSyCzvLYiTUIGWW57eihUQsQT6Lh77RpHAY7kdTz0HwwBSh/zPDalj4KFV+06emrVhALSZ/h8rxrIAUsgs7y2Ik1CBlluezooVELEE+i4e+0aRwGO5HU89B8MAUof8zw2pY+ChVftOnpq1YQC0mf4fK8ayAFLILO8tiJNQgZZbnt6KFRCxBPouHvtGkcBjuR1PPQfDAFKH/M8NqWPgoVX7Tp6atWEAtJn+HyvGsgBSyCzvLYiTUIGWW57eihUQsQT6Lh77RpHAY7kdTz0HwwBSh/zPDalj4KFV+06emrVhALSZ/h8rxrIAUsgs7y2Ik1CBlluezooVELEE+i4e+0aRwGO5HU89B8MAUof8zw2pY+ChVftOnpq1YQC0mf4fK8ayAFLILO8tiJNQgZZbnt6KFRCxBPouHvtGkcBjuR1PPQfDAFKH/M8NqWPgoVX7Tp6atWEAtJn+HyvGsgBQ==');
                }
                notificationSound.play().catch(e => console.log('Audio play failed:', e));
            } catch (e) {
                console.log('Audio not supported:', e);
            }
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('hiding');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 5000);
        }
        
        function closeNotification(button) {
            const notification = button.closest('.notification');
            notification.classList.add('hiding');
            setTimeout(() => {
                notification.remove();
            }, 300);
        }
        
        // Check for new falls
        async function checkForNewFalls() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();
                
                if (stats.total > lastFallCount) {
                    // New fall detected, fetch latest fall data
                    const fallsResponse = await fetch('/api/falls?page=1&per_page=1');
                    const fallsData = await fallsResponse.json();
                    
                    if (fallsData.falls && fallsData.falls.length > 0) {
                        createNotification(fallsData.falls[0]);
                        lastFallCount = stats.total;
                    }
                }
            } catch (error) {
                console.error('Error checking for new falls:', error);
            }
        }
        
        // Show initial notification for mock mode
        function showMockNotification() {
            console.log('showMockNotification called');
            console.log('Mock mode:', dashboardData.mock_mode);
            console.log('Falls data:', dashboardData.falls);
            
            if (dashboardData.mock_mode === true) {
                if (dashboardData.falls && dashboardData.falls.length > 0) {
                    const latestFall = dashboardData.falls[0];
                    console.log('Creating notification for fall:', latestFall);
                    setTimeout(() => {
                        createNotification(latestFall);
                    }, 1000);
                } else {
                    console.log('No falls data available');
                }
            } else {
                console.log('Not in mock mode, skipping mock notification');
            }
        }
        
        // Also show notification for real data on first load
        function showInitialNotification() {
            console.log('showInitialNotification called');
            // Show notification for the latest fall on page load (both mock and real)
            if (dashboardData.falls && dashboardData.falls.length > 0) {
                const latestFall = dashboardData.falls[0];
                console.log('Creating initial notification for fall:', latestFall);
                setTimeout(() => {
                    createNotification(latestFall);
                }, 2000);
            }
        }
        
        // Theme Management
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            const themeIcon = document.getElementById('themeIcon');
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update icon
            if (newTheme === 'dark') {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            } else {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
        }
        
        // Load saved theme
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const html = document.documentElement;
            const themeIcon = document.getElementById('themeIcon');
            
            html.setAttribute('data-theme', savedTheme);
            
            if (savedTheme === 'dark') {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            }
        }
        
        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            console.log('Dashboard data:', dashboardData);
            
            loadTheme();
            initializeCharts(dashboardData.stats);
            updateLastUpdated();
            
            // Show notification for the latest fall (works for both mock and real data)
            showInitialNotification();
            
            // Check for new falls every 10 seconds
            setInterval(checkForNewFalls, 10000);
            
            // Refresh data every 30 seconds
            setInterval(refreshData, 30000);
        });
    </script>
</body>
</html>
